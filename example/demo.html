<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <title>trading_engine 简单使用案例体验</title>
    <link rel="stylesheet" type="text/css" href="//www.layuicdn.com/layui/css/layui.css" />
  </head>
  
  <script id="depth-ask-tpl" type="text/html">

    <tr><th colspan="2" style="text-align:center;">委托</th></tr>
    <tr><th width="40%">价格</th><th>数量</th></tr>
    
    {%#  layui.each(d, function(index, item){ %}
    <tr>
        <td>{% item[0] %}</td><td>{% item[1] %}</td>
    </tr>
    {%#  }); %} 
  </script>

  <script id="depth-bid-tpl" type="text/html">
    {%#  layui.each(d, function(index, item){ %}
    <tr>
        <td width="40%">{% item[0] %}</td><td>{% item[1] %}</td>
    </tr>
    {%#  }); %}
  </script>

  <script id="trade-log-tpl" type="text/html">
    <tr class="log-item">
        <td>{% d.TradePrice %}</td>
        <td>{% d.TradeQuantity %}</td>
        <td>{% d.TradeAmount %}</td>
        <td>{% d.TradeTime %}</td>
    </tr>
  </script>
  
  <script id="myorder-tpl" type="text/html">
    <tr class="order-item" order-id="{% d.order_id%}">
        <td>{% d.price_type %}</td>
        <td>{% d.price %}</td>
        <td>{% d.quantity %}</td>
        <td>{% d.amount %}</td>
        <td>{% d.create_time %}</td>
        <td><a class="cancel" href="javascript:;">撤单</a></td>
    </tr>
  </script> 

  <body>
    <div class="main ">
        <div class="layui-row layui-col-space10">
            <div class="layui-col-md4 ">
                <div class="layui-row layui-col-space5">
                    <table class="layui-table depth-ask" style="background-color: #FFB800;">
                        <tr><th colspan="2" style="text-align:center;">委托</th></tr>
                        <tr><th width="40%">价格</th><th>数量</th></tr>
                        <tr></tr>
                    </table>
                </div>

                <div class="layui-row layui-col-space5">
                    <table class="layui-table depth-bid" style="background-color: #5FB878;">
                        <tr></tr>
                    </table>
                </div>
            </div>

            <div class="layui-col-md4">
                <table class="layui-table trade-log">
                    <tr><th style="text-align: center;" colspan="4">成交记录</th></tr>
                    <tr>
                        <th>价格</th>
                        <th>数量</th>
                        <th>金额</th>
                        <th>时间</th>
                    </tr>
                    <tr class="log"></tr>
                    
                </table>
            </div>

            <div class="layui-col-md4">
                <div class="layui-row">
                    <div class="layui-card">
                        <div class="layui-card-header"><b>测试下单</b></div>
                        <div class="layui-card-body">
                            <form class="layui-form" onsubmit="return false">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">订单类型</label>
                                    <div class="layui-input-block">
                                        <select name="price_type" lay-filter="price_type">
                                            <option value="limit">限价单</option>
                                            <option value="market">市价单</option>
                                        </select>   
                                    </div>
                                </div>

                                <div class="layui-form-item item-market-type" style="display: none;">
                                    <label class="layui-form-label"></label>
                                    <div class="layui-input-block">
                                        <input type="radio" name="mtype" lay-filter="market-type" value="q" title="按数量" checked>
                                        <input type="radio" name="mtype" lay-filter="market-type" value="a" title="按金额" disabled>
                                    </div>
                                </div>

                                <div class="layui-form-item item-price">
                                    <label class="layui-form-label">价格</label>
                                    <div class="layui-input-block">
                                    <input type="text" name="price" required  lay-verify="required|number" placeholder="请输入价格" autocomplete="off" class="layui-input" value="1.00">
                                    </div>
                                </div>
                                
                                
                                <div class="layui-form-item item-quantity">
                                    <label class="layui-form-label">数量</label>
                                    <div class="layui-input-inline">
                                    <input type="text" name="quantity" required lay-verify="required|number" placeholder="请输入数量" autocomplete="off" class="layui-input" value="10">
                                    </div>
                                </div>

                                <div class="layui-form-item item-amount" style="display: none;">
                                    <label class="layui-form-label">金额</label>
                                    <div class="layui-input-inline">
                                    <input type="text" name="amount" required lay-verify="required|number" placeholder="交易金额" autocomplete="off" class="layui-input" value="1000.00">
                                    </div>
                                </div>

                                <div class="layui-form-item">
                                    <div class="layui-input-block">
                                    <button class="layui-btn layui-btn-danger opt sell">卖出</button>
                                    <button class="layui-btn layui-btn-primary opt buy">买入</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="layui-row">
                    <div class="layui-card">
                        <div class="layui-card-header"><b>我的下单</b></div>
                        <div class="layui-card-body">
                            <table class="layui-table">
                                <tr>
                                    <th>类型</th>
                                    <th>价格</th>
                                    <th>数量</th>
                                    <th>金额</th>
                                    <th>时间</th>
                                    <th>操作</th>
                                </tr>
                                <tr class="myorder"></tr>
                                
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
    </div>


    

    <script src="//www.layuicdn.com/layui/layui.js"></script>
    <!--您的Layui代码start-->
    <script type="text/javascript">
    layui.use(['laydate', 'layer', 'table', 'element', 'laytpl', 'form'], function() {
      var laydate = layui.laydate //日期
      ,layer = layui.layer //弹层
      ,table = layui.table //表格
      ,$ =layui.$
      ,laytpl = layui.laytpl
      ,form = layui.form
      ,element = layui.element; //元素操作 等等...

      laytpl.config({
            open: '{%',
            close: '%}'
        });



    function formatTime(t) {
        var d = new Date(t);
        return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
    }

      /*layer弹出一个示例*/
      //   layer.msg('Hello World');

      $(".opt").on("click", function(){
          var type = $(this).hasClass("sell") ? "ask" : "bid";
          var price_type = $("select[name='price_type']").val();
          var mtype = $("input[name='mtype']:checked").val();
          
          $.ajax({
              url:"/api/new_order",
              type: "post",
              dataType: "json",
              contentType : "application/json",
              data: function(){
                var data = {
                    price_type: price_type,
                    order_type: type,
                };

                if (price_type == "market") {
                    if(mtype == "q") {
                        data.quantity = $("input[name='quantity']").val();
                    } else {
                        data.amount = $("input[name='amount']").val();
                    }
                }else{
                    data.price = $("input[name='price']").val();
                    data.quantity = $("input[name='quantity']").val();
                }

                console.log(data);
                return JSON.stringify(data)
              }(),
              success: function(d){
                layer.msg("下单"+ d.ok + " askLen:"+ d.data.ask_len + " bidLen:"+ d.data.bid_len);
              }
          });
      });

      $("body").on("click", ".cancel", function(){
            var me = $(this);
            $.ajax({
                url:"/api/cancel_order",
                type: "post",
                dataType: "json",
                contentType : "application/json",
                data: JSON.stringify({
                        order_id: me.parents("tr").attr("order-id")
                }),
                success: function(d){
                    layer.msg("取消 "+ d.ok );
                    if(d.ok){
                        me.parents("tr").remove();
                    }
                }
            });
      });

      
      form.on('select(price_type)', function(data){
        if(data.value=="limit"){
            $(".item-price").show();
            $(".item-quantity").show();
            $(".item-amount").hide();
            $(".item-market-type").hide();
        }else if(data.value=="market"){
            $(".item-price").hide();
            $(".item-market-type").show();
        }
        form.render('select');
      });
      form.on('radio(market-type)', function(data){
          if(data.value =="q"){
            $(".item-quantity").show();
            $(".item-amount").hide();
          }else{
            $(".item-quantity").hide();
            $(".item-amount").show();
          }
      });
      

      
       
    



      var socket = function(){
            if (window["WebSocket"]) {
                var protocol = window.location.protocol == "https:" ? "wss:" : "ws:";
                conn = new WebSocket(protocol +"//" + document.location.host + "/ws");
                conn.onclose = function (evt) {
                    layer.msg("<b>WebSocket Connection closed</b>");
                    setTimeout(function(){
                        socket();
                    }, 5e3);
                };
                conn.onmessage = function (evt) {
                    var messages = evt.data.split('\n');
                    for (var i = 0; i < messages.length; i++) {
                        var data = JSON.parse(messages[i]);
                        if (data.tag == "depth") {
                            var info = data.data;
                            var askTpl = $("#depth-ask-tpl").html()
                                , askView = $(".depth-ask")
                                , bidTpl = $("#depth-bid-tpl").html()
                                , bidView = $(".depth-bid");

                            
                            laytpl(askTpl).render(info.ask.reverse(), function (html) {
                                askView.html(html);
                            });
                            laytpl(bidTpl).render(info.bid, function (html) {
                                bidView.html(html);
                            });
                            


                        }else if(data.tag == "trade") {
                            var logView = $(".trade-log .log"),
                                logTpl = $("#trade-log-tpl").html();
                            
                            data.data['TradeTime'] = formatTime(data.data.TradeTime);
                            laytpl(logTpl).render(data.data, function (html) {
                                if($(".log-item").length > 10) {
                                    $(".log-item").last().remove();
                                }
                                logView.after(html);

                                //remove myorder
                                $("tr[order-id='"+ data.data.AskOrderId +"']").remove();
                                $("tr[order-id='"+ data.data.BidOrderId +"']").remove();
                            });
                        }else if(data.tag == "new_order") {
                            var myorderView = $(".myorder"),
                                myorderTpl = $("#myorder-tpl").html();
                            
                            data.data['create_time'] = formatTime(data.data.create_time);
                            laytpl(myorderTpl).render(data.data, function (html) {
                                if($(".order-item").length > 30) {
                                    $(".order-item").last().remove();
                                }
                                myorderView.after(html);
                            });
                        }
                    }
                };
            } else {
                layer.msg("<b>Your browser does not support WebSockets.</b>");
            }
        };
        socket();

    });
    </script>
  </body>

</html>